<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuickServe</title>
  <script src="http://www2.corp.1010data.com/beta-latest/js/require.js"></script>
  <script>
    require.config({
      paths: { Vue: 'https://cdn.jsdelivr.net/npm/vue/dist/vue' }});
  </script>
  <style>
    body, th, td { font-family: Calibri, Arial, sans-serif; }
    html, body, #app, main, iframe { padding:0; margin:0; height:100%; width:100% }
    th, td { border: solid silver 1px; padding: 2px; background: white; }
    th { background: silver; }
    label { display: block; margin-top: 20px; }
  </style>
</head>
<body>
  <div id="app">
    <nav>QuickServe: {{appPath}} &rarr; tag {{tag}}</nav>
    <main v-if="tag!=0"><iframe :src="iframeSrc"></iframe></main>
  </div>
</body>
<script>
require(['Vue', '1010api2-html'], function(Vue, api2) {
  // --- app logic starts here ------------------------------------

  const data = { tag:0, widgets:[], model: {}, scope:{}, appPath: 'quickapp.xml'}
        ac = new api2.API2Client(),
        xr = new XMLHttpRequest();

  let vm = new Vue({
    el: '#app', data,
    methods: {
      setState(e) { this.interact({state: e.value}) },
      setStation(e) { if (e.target.checked) this.interact({id: e.target.value })},
      interact(args) {
        ac.call(data.tag.toString(), args).then(r=> {
          handleWidgetTable(ac, data, r);
          Object.keys(r.changes).forEach(k => Vue.set(data.scope, k, r.changes[k])); })
        .catch(e=>{
          console.log('error on interact', e);
          if (e instanceof XMLHttpRequest && e.status===403) document.location = '/!logout'; }); }},
    computed: {
      iframeSrc: function() { return '/cgi-bin/remote/quickapp.k?tag_=' + data.tag },
      dateStr: {
        get() {
          if (!this.model.date) return '';
          return this.model.date.toString().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3') },
        set(v) { this.model.date = parseInt(v.replaceAll('-','')); this.interact({date: this.model.date}) } },
      stateCodes: function() {
        var res = this.model['states']['state'].map(x=>x); // TODO: make this not change
        return res.sort(); }}});

  // fetch macro code and run it as a quickapp
  xr.open('GET', data.appPath);
  xr.onload = function() {
    ac.call('new', {xml: xr.responseText})
      .then(r=> ac.call('/' + (data.tag = r.tag), { method_:'GET', fmt_:'json.rows' }))
      .catch(e=>{
        console.log('error running quickapp:', e);
        if (e instanceof XMLHttpRequest && e.status===403) document.location = '/!logout'; }); };
  xr.send();

  // expose all this stuff for debug purposes
  window.vm = vm; window.data = data; window.ac=ac;
});
</script>
</html>
